{% extends 'layout.html' %}
{% block title %}SSL Filtering - Squid Flask Proxy{% endblock %}

{% block content %}
<h1 class="page-title">SSL Filtering</h1>
<p class="page-subtitle">Control which clients are exempt from TLS interception (ssl-bump).</p>

<section class="card" style="margin-bottom: 14px;">
  <div class="card-header">
    <h2 class="card-title">Why this matters</h2>
  </div>
  <div class="card-body">
    <div class="help" style="max-width: 980px;">
      Some networks contain unmanaged devices (guest BYOD, IoT, consoles, printers) that cannot have a custom CA certificate installed.
      If Squid "bumps" TLS for these clients, they will see certificate errors or fail to connect.
      <br><br>
      Adding these clients (by CIDR) to the no-bump list makes Squid "splice" their TLS connections instead (a pass-through tunnel),
      so they see the real website certificates.
      <br><br>
      Note: Certbot/Let's Encrypt cannot replace ssl-bump for general web browsing because Let's Encrypt only issues certificates for domains you control.
      A bumping proxy would need certificates for arbitrary destinations (e.g. google.com), which public CAs will not issue.
    </div>
  </div>
</section>

<section class="card">
  <div class="card-header">
    <h2 class="card-title">No-bump client CIDRs</h2>
    <span class="badge">Splice only</span>
  </div>
  <div class="card-body">
    {% if ok %}
      <div style="margin: 0 0 12px;"><span class="badge ok">Saved</span></div>
    {% endif %}
    {% if err %}
      <div style="margin: 0 0 12px;"><span class="badge danger">Error</span> <span class="small">{{ err }}</span></div>
    {% endif %}

    <form method="post" class="form" action="{{ url_for('sslfilter') }}">
      {{ csrf_field() }}
      <input type="hidden" name="action" value="add">
      <label for="cidr">Add CIDR</label>
      <div style="display:flex; gap:10px; align-items:center;">
        <input id="cidr" class="input" type="text" name="cidr" placeholder="10.0.0.0/8 or 192.168.1.50" style="flex: 1 1 auto;">
        <button class="btn" type="submit">Add</button>
      </div>
      <div class="help">Matches client IPs; matching clients will be spliced (no TLS interception). Changes apply immediately.</div>
    </form>

    <div style="margin-top: 14px;">
      {% if rows and rows|length > 0 %}
        <table class="table">
          <thead>
            <tr>
              <th>CIDR</th>
              <th>Added</th>
              <th style="width: 1%;">Action</th>
            </tr>
          </thead>
          <tbody>
            {% for cidr, ts in rows %}
              <tr>
                <td style="font-family: var(--mono);">{{ cidr }}</td>
                <td class="small">{{ fmt_ts(ts) if ts else '' }}</td>
                <td>
                  <form method="post" action="{{ url_for('sslfilter') }}" style="margin:0;">
                    {{ csrf_field() }}
                    <input type="hidden" name="action" value="remove">
                    <input type="hidden" name="cidr" value="{{ cidr }}">
                    <button class="btn ghost" type="submit">Remove</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="help">No no-bump CIDRs configured.</div>
      {% endif %}
    </div>
  </div>
</section>

{% endblock %}
