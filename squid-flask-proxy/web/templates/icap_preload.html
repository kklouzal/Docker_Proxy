{% extends "layout.html" %}

{% block title %}ICAP Preload · Squid Flask Proxy{% endblock %}

{% block content %}
<h1 class="page-title">ICAP Preload</h1>
<p class="page-subtitle">RESPMOD HTML rewriting: injects <span style="font-family: var(--mono);">&lt;link rel="preload" as="image"&gt;</span> for <span style="font-family: var(--mono);">&lt;img src&gt;</span> URLs.</p>

<div class="actions" style="margin-bottom: 12px;">
  {% if preload_enabled %}
    <span class="badge ok">Active</span>
  {% else %}
    <span class="badge danger">Disabled</span>
  {% endif %}

  <form method="post" action="{{ url_for('icap_preload_toggle') }}" style="display:inline;">
    {% if preload_enabled %}
      <button class="btn" type="submit" name="action" value="disable">Disable</button>
    {% else %}
      <button class="btn primary" type="submit" name="action" value="enable">Enable</button>
    {% endif %}
  </form>
</div>

<div class="grid">
  <section class="card">
    <div class="card-header">
      <h2 class="card-title">Status</h2>
      {% if health and health.ok %}
        <span class="badge ok">Running</span>
      {% else %}
        <span class="badge danger">Not responding</span>
      {% endif %}
    </div>
    <div class="card-body">
      <div class="kv">
        <div class="k">Health check</div>
        <div class="v">
          {% if health and health.ok %}
            OK
          {% else %}
            Failed
          {% endif %}
          {% if health and health.detail %}
            <span class="small" style="font-family: var(--mono);"> · {{ health.detail }}</span>
          {% endif %}
        </div>

        <div class="k">First seen</div>
        <div class="v"><span class="small">{% if stats and stats.first_seen %}{{ fmt_ts(stats.first_seen) }}{% else %}-{% endif %}</span></div>

        <div class="k">Last seen</div>
        <div class="v"><span class="small">{% if stats and stats.last_seen %}{{ fmt_ts(stats.last_seen) }}{% else %}-{% endif %}</span></div>

        <div class="k">Last injected</div>
        <div class="v"><span class="small">{% if stats and stats.last_injected %}{{ fmt_ts(stats.last_injected) }}{% else %}-{% endif %}</span></div>

        <div class="k">Last failure</div>
        <div class="v">
          <span class="small">{% if stats and stats.last_failure %}{{ fmt_ts(stats.last_failure) }}{% else %}-{% endif %}</span>
          {% if stats and stats.last_failure_msg %}
            <div class="small" style="margin-top: 6px; font-family: var(--mono); overflow-wrap: anywhere;">{{ stats.last_failure_msg }}</div>
          {% endif %}
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="card-header">
      <h2 class="card-title">Rewrite statistics</h2>
      <span class="badge">counters</span>
    </div>
    <div class="card-body">
      <div class="grid" style="grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 12px;">
        <div class="stat">
          <div class="stat-k">RESPMOD calls</div>
          <div class="stat-v">{{ stats.respmod_calls if stats else 0 }}</div>
        </div>
        <div class="stat">
          <div class="stat-k">Responses modified</div>
          <div class="stat-v">{{ stats.injected_responses if stats else 0 }}</div>
        </div>
        <div class="stat">
          <div class="stat-k">Preload links added</div>
          <div class="stat-v">{{ stats.injected_links if stats else 0 }}</div>
        </div>
      </div>

      <table class="table" style="margin-top: 14px;">
        <thead>
          <tr>
            <th>Skip / failure reason</th>
            <th class="num">Count</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>Skipped: non-HTML</td><td class="num">{{ stats.skipped_non_html if stats else 0 }}</td></tr>
          <tr><td>Skipped: no &lt;/head&gt; or no &lt;img src&gt;</td><td class="num">{{ stats.skipped_no_head_or_imgs if stats else 0 }}</td></tr>
          <tr><td>Skipped: unsupported encoding</td><td class="num">{{ stats.skipped_unsupported_encoding if stats else 0 }}</td></tr>
          <tr><td>Skipped: incomplete body</td><td class="num">{{ stats.skipped_incomplete_body if stats else 0 }}</td></tr>
          <tr><td>Skipped: missing ICAP parts</td><td class="num">{{ stats.skipped_missing_parts if stats else 0 }}</td></tr>
          <tr><td>Failures</td><td class="num">{{ stats.failures if stats else 0 }}</td></tr>
        </tbody>
      </table>

      <div class="small" style="margin-top: 10px;">
        Notes: This page counts only what the ICAP server reports. Squid is configured with <span style="font-family: var(--mono);">bypass=on</span>, so transient ICAP failures should not break browsing.
      </div>
    </div>
  </section>
</div>
{% endblock %}
