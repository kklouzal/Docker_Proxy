# Minimal c-icap config for AV experimentation.
# NOTE: Exact module/service names depend on the built c-icap-modules set.
# We'll start with a conservative config and adjust after verifying the installed .so names.

ServerName squid-flask-proxy-cicap
PidFile /var/run/c-icap/c-icap.pid

# Use a port dedicated to c-icap (separate from Squid's proxy ports).
# Bind explicitly to IPv4 loopback so Squid's icap://127.0.0.1:14000/... endpoints work.
Port 127.0.0.1:14000

# Paths (defaults for source installs; included for clarity)
ModulesDir /usr/lib/c_icap
ServicesDir /usr/lib/c_icap
TemplateDir /usr/share/c_icap/templates

# Logging to stdout/stderr via supervisord
DebugLevel 1

# Access logging (per ICAP transaction)
# Useful for seeing REQMOD decisions directly from c-icap (including srv_url_check).
# Fields (TSV): epoch_ms, http_client_ip, remote_ip, icap_method, icap_path, icap_status,
#   http_request_line, http_url, http_response_line, service_log
LogFormat adblock_access "%{m}ts\t%>a\t%a\t%im\t%iu\t%is\t%>ho\t%huo\t%<ho\t%Sl"
AccessLog /var/log/cicap-access.log adblock_access

# Load AV engine modules before starting AV services.
Include /etc/clamd_mod.conf

# Service mapping:
# We intentionally name it "avrespmod" to match the Squid ICAP URL path.
# Use the c-icap-modules virus_scan service, and alias it to match Squid's ICAP URL path.
Service virus_scan virus_scan.so
ServiceAlias avrespmod virus_scan?allow204=on&sizelimit=off&mode=simple

# Adblock REQMOD (first-pass) served by c-icap using srv_url_check.
# Squid uses the ICAP path /adblockreq.
Service ad_block_req srv_url_check.so
ServiceAlias adblockreq ad_block_req

# Module/service configuration (provided by this repo)
# These files are copied into /etc (not /etc/c-icap), so use absolute paths.
Include /etc/virus_scan.conf

# Config for adblock REQMOD service
Include /etc/adblock_req.conf
