# Adblock REQMOD via c-icap srv_url_check
#
# This file is included by /etc/c-icap/c-icap.conf.
# It configures the url_check service to act as a fast first-pass ad blocker.
#
# Data inputs (generated by /app/tools/adblock_compile.py):
# - /var/lib/squid-flask-proxy/adblock/compiled/domains_allow.txt
# - /var/lib/squid-flask-proxy/adblock/compiled/domains_block.txt
# - /var/lib/squid-flask-proxy/adblock/compiled/regex_allow.txt
# - /var/lib/squid-flask-proxy/adblock/compiled/regex_block.txt
#
# Strategy:
# 1) PASS if request host matches an exception domain suffix.
# 2) PASS if request URL matches an exception regex.
# 3) BLOCK if request host matches a blocked domain suffix.
# 4) BLOCK if request URL matches a blocked regex.
# 5) PASS everything else.

# Keep percent-encoding normalization consistent with generated tables.
url_check.ConvertPercentCodesTo lowercase

# Use in-memory hash lookup tables for speed.
url_check.LookupTableDB adblock_allow domain hash:/var/lib/squid-flask-proxy/adblock/compiled/domains_allow.txt "Adblock exceptions (domain)"
url_check.LookupTableDB adblock_block domain hash:/var/lib/squid-flask-proxy/adblock/compiled/domains_block.txt "Adblock blocks (domain)"

# Regex lookup tables (compiled from option-less /regex/ rules).
# Note: these entries are stored in /.../ form (c-icap regex table format).
url_check.LookupTableDB adblock_regex_allow full_url regex:/var/lib/squid-flask-proxy/adblock/compiled/regex_allow.txt "Adblock exceptions (regex)"
url_check.LookupTableDB adblock_regex_block full_url regex:/var/lib/squid-flask-proxy/adblock/compiled/regex_block.txt "Adblock blocks (regex)"

# Default policy chain (order matters).
url_check.Profile default pass adblock_allow
url_check.Profile default pass adblock_regex_allow
url_check.Profile default block adblock_block
url_check.Profile default block adblock_regex_block
url_check.Profile default pass ALL
