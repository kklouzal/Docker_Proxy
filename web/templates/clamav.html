{% extends "layout.html" %}

{% block title %}ClamAV · Squid Flask Proxy{% endblock %}

{% block content %}
<h1 class="page-title">ClamAV</h1>
<p class="page-subtitle">RESPMOD antivirus scan via c-icap (virus_scan + clamd).</p>

<div class="actions" style="margin-bottom: 12px;">
  {% if clamav_enabled %}
    <span class="badge ok">Active</span>
  {% else %}
    <span class="badge danger">Disabled</span>
  {% endif %}

  <form method="post" action="{{ url_for('clamav_toggle') }}" style="display:inline;">
    {{ csrf_field() }}
    {% if clamav_enabled %}
      <button class="btn" type="submit" name="action" value="disable">Disable</button>
    {% else %}
      <button class="btn primary" type="submit" name="action" value="enable">Enable</button>
    {% endif %}
  </form>

  {% if health and health.ok %}
    <span class="badge ok">Running</span>
  {% else %}
    <span class="badge danger">Not responding</span>
  {% endif %}
  {% if health and health.detail %}
    <span class="small" style="font-family: var(--mono);">{{ health.detail }}</span>
  {% endif %}

  <form method="post" action="{{ url_for('clamav_test_eicar') }}" style="display:inline; margin-left: 12px;">
    {{ csrf_field() }}
    <button class="btn" type="submit">Test EICAR</button>
  </form>
  <form method="post" action="{{ url_for('clamav_test_icap') }}" style="display:inline; margin-left: 8px;">
    {{ csrf_field() }}
    <button class="btn" type="submit">Send sample ICAP</button>
  </form>

  {% if eicar_result %}
    {% if eicar_result == 'ok' %}<span class="badge ok">EICAR detected</span>{% else %}<span class="badge danger">EICAR failed</span>{% endif %}
    {% if eicar_detail %}<span class="small" style="font-family: var(--mono);">{{ eicar_detail }}</span>{% endif %}
  {% endif %}
  {% if icap_result %}
    {% if icap_result == 'ok' %}<span class="badge ok">ICAP sample ok</span>{% else %}<span class="badge danger">ICAP sample failed</span>{% endif %}
    {% if icap_detail %}<span class="small" style="font-family: var(--mono);">{{ icap_detail }}</span>{% endif %}
  {% endif %}
</div>

<div class="grid">
  <section class="card" style="grid-column: 1 / -1;">
    <div class="card-header">
      <h2 class="card-title">Notes</h2>
      <span class="badge">c-icap</span>
    </div>
    <div class="card-body">
      <div class="small">
        Squid is configured with <span style="font-family: var(--mono);">bypass=on</span> for ICAP services.
        If ClamAV or c-icap is down, browsing should continue (fail-open) but scans won’t occur.
      </div>
      <div class="small" style="margin-top: 10px;">
        AV scanning behavior is controlled by c-icap configuration inside the container (e.g. <span style="font-family: var(--mono);">/etc/virus_scan.conf</span>).
      </div>
    </div>
  </section>
</div>
{% endblock %}
