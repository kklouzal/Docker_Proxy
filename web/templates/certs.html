{% extends "layout.html" %}

{% block title %}Certificates Â· Squid Flask Proxy{% endblock %}

{% block content %}
<h1 class="page-title">Certificates</h1>
<p class="page-subtitle">Generate the CA certificate used for HTTPS SSL-bump and download it for client trust stores.</p>

{% if message %}
<div class="card" style="margin-bottom: 12px;">
    <div class="card-body">
        {% if message_ok %}
            <span class="badge ok">Success</span>
        {% else %}
            <span class="badge danger">Error</span>
        {% endif %}
        <span class="small" style="margin-left: 8px;">{{ message }}</span>
    </div>
</div>
{% endif %}

<div class="grid">
    <section class="card split-left">
        <div class="card-header">
            <h2 class="card-title">CA Certificate</h2>
            {% if certificate %}
                <span class="badge ok">Available</span>
            {% else %}
                <span class="badge warn">Not generated</span>
            {% endif %}
        </div>
        <div class="card-body">
            <div class="small">
                This certificate must be installed on client devices to avoid HTTPS warnings when using SSL-bump.
            </div>
            <div class="actions" style="margin-top: 12px;">
                <form action="{{ url_for('generate_certificate') }}" method="post">
                    {{ csrf_field() }}
                    <button class="btn primary" type="submit">Generate/Ensure CA</button>
                </form>
                {% if certificate %}
                    <a class="btn" href="{{ url_for('download_certificate', filename=certificate) }}">Download CA</a>
                {% else %}
                    <a class="btn" href="{{ url_for('download_certificate', filename='ca.crt') }}">Download CA</a>
                {% endif %}
            </div>

            <div style="margin-top: 16px;">
                <div class="small" style="margin-bottom: 8px;">
                    Upload a PKCS#12 bundle (.pfx/.p12) that contains a certificate and private key. If valid, it will replace the current CA used by Squid SSL-bump.
                </div>
                <form class="form" action="{{ url_for('upload_certificate_pfx') }}" method="post" enctype="multipart/form-data">
                    {{ csrf_field() }}
                    <div>
                        <label for="pfx">PFX / P12 file</label>
                        <input id="pfx" name="pfx" type="file" accept=".pfx,.p12,application/x-pkcs12" required>
                    </div>
                    <div>
                        <label for="pfx_password">Password (optional)</label>
                        <input id="pfx_password" name="pfx_password" type="password" placeholder="Leave blank if none">
                    </div>
                    <div class="actions">
                        <button class="btn primary" type="submit">Upload and Use</button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <aside class="card split-right">
        <div class="card-header">
            <h2 class="card-title">Security Notes</h2>
        </div>
        <div class="card-body">
            <div class="small">
                - Only the public CA cert is downloadable.
                <br>
                - The private key stays in the container.
                <br>
                - Treat SSL-bump as MITM; use with explicit authorization.
            </div>
        </div>
    </aside>
</div>
{% endblock %}