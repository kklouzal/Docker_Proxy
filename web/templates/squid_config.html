{% extends "layout.html" %}

{% block title %}Squid Config · Squid Flask Proxy{% endblock %}

{% block content %}
<h1 class="page-title">Squid Configuration</h1>
<p class="page-subtitle">Manage the running <span style="font-family: var(--mono);">squid.conf</span> and common caching settings.</p>

<div class="actions" style="margin: 10px 0 14px;">
    <a class="btn {{ 'primary' if tab == 'config' else 'ghost' }}" href="{{ url_for('squid_config', tab='config') }}">Config</a>
    <a class="btn {{ 'primary' if tab == 'caching' else 'ghost' }}" href="{{ url_for('squid_config', tab='caching') }}">Caching</a>
    <a class="btn {{ 'primary' if tab == 'timeouts' else 'ghost' }}" href="{{ url_for('squid_config', tab='timeouts') }}">Timeouts</a>
    <a class="btn {{ 'primary' if tab == 'logging' else 'ghost' }}" href="{{ url_for('squid_config', tab='logging') }}">Logging</a>
    <a class="btn {{ 'primary' if tab == 'network' else 'ghost' }}" href="{{ url_for('squid_config', tab='network') }}">Network</a>
    <a class="btn {{ 'primary' if tab == 'dns' else 'ghost' }}" href="{{ url_for('squid_config', tab='dns') }}">DNS</a>
    <a class="btn {{ 'primary' if tab == 'ssl' else 'ghost' }}" href="{{ url_for('squid_config', tab='ssl') }}">SSL</a>
    <a class="btn {{ 'primary' if tab == 'icap' else 'ghost' }}" href="{{ url_for('squid_config', tab='icap') }}">ICAP</a>
    <a class="btn {{ 'primary' if tab == 'privacy' else 'ghost' }}" href="{{ url_for('squid_config', tab='privacy') }}">Privacy</a>
    <a class="btn {{ 'primary' if tab == 'limits' else 'ghost' }}" href="{{ url_for('squid_config', tab='limits') }}">Limits</a>
    <a class="btn {{ 'primary' if tab == 'performance' else 'ghost' }}" href="{{ url_for('squid_config', tab='performance') }}">Performance</a>
    <a class="btn {{ 'primary' if tab == 'http' else 'ghost' }}" href="{{ url_for('squid_config', tab='http') }}">HTTP</a>
</div>

{% if request.args.get('ok') %}
    <div style="margin: 0 0 14px;"><span class="badge ok">Applied</span> <span class="small">Config validated and Squid reloaded.</span></div>
{% elif request.args.get('error') %}
    <div style="margin: 0 0 14px;"><span class="badge danger">Failed</span> <span class="small">Config validation/reload failed; previous config kept.</span></div>
{% endif %}

{% if validation %}
    <div style="margin: 0 0 14px;">
        {% if validation.ok %}
            <span class="badge ok">Validation passed</span>
        {% else %}
            <span class="badge danger">Validation failed</span>
        {% endif %}
        <pre class="small" style="white-space: pre-wrap; margin-top: 6px;">{{ validation.detail }}</pre>
    </div>
{% endif %}

<div class="grid">
    {% if tab == 'config' %}
        <section class="card">
            <div class="card-header">
                <h2 class="card-title">squid.conf</h2>
                <span class="badge">Validates on save</span>
            </div>
            <div class="card-body">
                <form class="form" action="{{ url_for('squid_config', tab=tab) }}" method="post">
                    {{ csrf_field() }}
                    <input type="hidden" name="tab" value="{{ tab }}" />
                    <label for="config_text">Configuration file</label>
                    <textarea id="config_text" name="config_text" spellcheck="false" autocapitalize="off" autocomplete="off" autocorrect="off">{{ config_text }}</textarea>
                    <div class="actions">
                        <button class="btn primary" type="submit" name="action" value="apply">Save & Reload</button>
                        <button class="btn ghost" type="submit" name="action" value="validate">Validate only</button>
                        <button class="btn ghost" type="button" id="reload-running-config" data-url="{{ url_for('api_squid_config') }}">Reload from running config</button>
                    </div>
                    <div class="small">The server validates the config before applying it; if validation fails, it keeps the previous config.</div>
                </form>
            </div>
        </section>
    {% elif tab == 'caching' %}
        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Caching settings</h2>
                <span class="badge">Running config</span>
            </div>
            <div class="card-body">
                <div class="small" style="margin-bottom: 8px;">Key caching directives detected in the current running <span style="font-family: var(--mono);">squid.conf</span>.</div>
                {% if caching_lines and caching_lines|length %}
                    <pre class="small" style="white-space: pre-wrap;">{{ caching_lines | join('\n') }}</pre>
                {% else %}
                    <div class="small">No caching directives detected.</div>
                {% endif %}
            </div>
        </section>

        <form id="safe-caching-form" action="{{ url_for('apply_safe_caching') }}" method="post">
            {{ csrf_field() }}
            <input type="hidden" name="form_kind" value="caching" />
        </form>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Cache sizing</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="form">
                    <label for="cache_dir_size_mb">Disk cache size (MB)</label>
                    <input form="safe-caching-form" id="cache_dir_size_mb" name="cache_dir_size_mb" type="number" min="100" step="100" value="{{ (tunables.cache_dir_size_mb if tunables and tunables.cache_dir_size_mb is not none else 10000) }}" />

                    <label for="cache_mem_mb">Memory cache (MB)</label>
                    <input form="safe-caching-form" id="cache_mem_mb" name="cache_mem_mb" type="number" min="16" step="16" value="{{ (tunables.cache_mem_mb if tunables and tunables.cache_mem_mb is not none else 256) }}" />
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Object limits</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="form">
                    <label for="maximum_object_size_mb">Max cached object size (MB)</label>
                    <input form="safe-caching-form" id="maximum_object_size_mb" name="maximum_object_size_mb" type="number" min="1" step="1" value="{{ (tunables.maximum_object_size_mb if tunables and tunables.maximum_object_size_mb is not none else 64) }}" />

                    <label for="maximum_object_size_in_memory_kb">Max in-memory object (KB)</label>
                    <input form="safe-caching-form" id="maximum_object_size_in_memory_kb" name="maximum_object_size_in_memory_kb" type="number" min="0" step="64" value="{{ (tunables.maximum_object_size_in_memory_kb if tunables and tunables.maximum_object_size_in_memory_kb is not none else 1024) }}" />

                    <label for="minimum_object_size_kb">Min object size (KB)</label>
                    <input form="safe-caching-form" id="minimum_object_size_kb" name="minimum_object_size_kb" type="number" min="0" step="1" value="{{ (tunables.minimum_object_size_kb if tunables and tunables.minimum_object_size_kb is not none else 0) }}" />
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Caching behavior</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="form">
                    <label for="cache_swap_low">cache_swap_low (%)</label>
                    <input form="safe-caching-form" id="cache_swap_low" name="cache_swap_low" type="number" min="0" max="100" step="1" value="{{ (tunables.cache_swap_low if tunables and tunables.cache_swap_low is not none else 90) }}" />

                    <label for="cache_swap_high">cache_swap_high (%)</label>
                    <input form="safe-caching-form" id="cache_swap_high" name="cache_swap_high" type="number" min="0" max="100" step="1" value="{{ (tunables.cache_swap_high if tunables and tunables.cache_swap_high is not none else 95) }}" />

                    <label class="check-row">
                        <input form="safe-caching-form" class="check" type="checkbox" name="collapsed_forwarding_on" {% if (tunables and tunables.collapsed_forwarding is not none and tunables.collapsed_forwarding) or (not tunables) or (tunables and tunables.collapsed_forwarding is none) %}checked{% endif %} />
                        <span>Enable collapsed forwarding</span>
                    </label>

                    <label class="check-row">
                        <input form="safe-caching-form" class="check" type="checkbox" name="range_cache_on" {% if (tunables and tunables.range_offset_limit is not none and tunables.range_offset_limit == -1) or (not tunables) or (tunables and tunables.range_offset_limit is none) %}checked{% endif %} />
                        <span>Enable caching of Range requests</span>
                    </label>

                    <label class="check-row">
                        <input form="safe-caching-form" class="check" type="checkbox" name="pipeline_prefetch_on" {% if (tunables and tunables.pipeline_prefetch is not none and tunables.pipeline_prefetch) or (not tunables) or (tunables and tunables.pipeline_prefetch is none) %}checked{% endif %} />
                        <span>Enable pipeline_prefetch</span>
                    </label>

                    <label for="cache_replacement_policy">Disk cache replacement policy</label>
                    <select form="safe-caching-form" id="cache_replacement_policy" name="cache_replacement_policy">
                        {% set crp = (tunables.cache_replacement_policy if tunables and tunables.cache_replacement_policy else 'heap GDSF') %}
                        <option value="heap GDSF" {% if crp == 'heap GDSF' %}selected{% endif %}>heap GDSF (higher hit-rate)</option>
                        <option value="heap LFUDA" {% if crp == 'heap LFUDA' %}selected{% endif %}>heap LFUDA</option>
                        <option value="lru" {% if crp == 'lru' %}selected{% endif %}>LRU</option>
                    </select>

                    <label for="memory_replacement_policy">Memory cache replacement policy</label>
                    <select form="safe-caching-form" id="memory_replacement_policy" name="memory_replacement_policy">
                        {% set mrp = (tunables.memory_replacement_policy if tunables and tunables.memory_replacement_policy else 'heap GDSF') %}
                        <option value="heap GDSF" {% if mrp == 'heap GDSF' %}selected{% endif %}>heap GDSF (higher hit-rate)</option>
                        <option value="heap LFUDA" {% if mrp == 'heap LFUDA' %}selected{% endif %}>heap LFUDA</option>
                        <option value="lru" {% if mrp == 'lru' %}selected{% endif %}>LRU</option>
                    </select>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Connection behavior</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="form">
                    <label class="check-row">
                        <input form="safe-caching-form" class="check" type="checkbox" name="client_persistent_connections_on" {% if (tunables and tunables.client_persistent_connections is not none and tunables.client_persistent_connections) or (not tunables) or (tunables and tunables.client_persistent_connections is none) %}checked{% endif %} />
                        <span>Client persistent connections</span>
                    </label>

                    <label class="check-row">
                        <input form="safe-caching-form" class="check" type="checkbox" name="server_persistent_connections_on" {% if (tunables and tunables.server_persistent_connections is not none and tunables.server_persistent_connections) or (not tunables) or (tunables and tunables.server_persistent_connections is none) %}checked{% endif %} />
                        <span>Server persistent connections</span>
                    </label>

                    <label for="read_ahead_gap_kb">read_ahead_gap (KB)</label>
                    <input form="safe-caching-form" id="read_ahead_gap_kb" name="read_ahead_gap_kb" type="number" min="0" step="1" value="{{ (tunables.read_ahead_gap_kb if tunables and tunables.read_ahead_gap_kb is not none else '') }}" />
                    <div class="small">Leave blank to keep the current/default value.</div>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">TTL and DNS</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="form">
                    <label for="negative_ttl_seconds">negative_ttl (seconds)</label>
                    <input form="safe-caching-form" id="negative_ttl_seconds" name="negative_ttl_seconds" type="number" min="0" step="1" value="{{ (tunables.negative_ttl_seconds if tunables and tunables.negative_ttl_seconds is not none else '') }}" />

                    <label for="positive_dns_ttl_seconds">positive_dns_ttl (seconds)</label>
                    <input form="safe-caching-form" id="positive_dns_ttl_seconds" name="positive_dns_ttl_seconds" type="number" min="0" step="1" value="{{ (tunables.positive_dns_ttl_seconds if tunables and tunables.positive_dns_ttl_seconds is not none else '') }}" />

                    <label for="negative_dns_ttl_seconds">negative_dns_ttl (seconds)</label>
                    <input form="safe-caching-form" id="negative_dns_ttl_seconds" name="negative_dns_ttl_seconds" type="number" min="0" step="1" value="{{ (tunables.negative_dns_ttl_seconds if tunables and tunables.negative_dns_ttl_seconds is not none else '') }}" />

                    <div class="small">Leave blank to keep the current/default values.</div>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Workers and abort behavior</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="form">
                    <label for="workers">Squid workers (SMP)</label>
                    <input form="safe-caching-form" id="workers" name="workers" type="number" min="1" max="4" step="1" value="{{ (tunables.workers if tunables and tunables.workers is not none else 2) }}" />
                    <div class="small">More workers improves throughput but uses more RAM. Recommended: 2–4.</div>
                    <div class="small">Note: Changing workers requires a full Squid restart (it cannot be applied with reconfigure). This UI will restart Squid automatically.</div>

                    <label for="quick_abort_min_kb">quick_abort_min (KB)</label>
                    <input form="safe-caching-form" id="quick_abort_min_kb" name="quick_abort_min_kb" type="number" min="0" step="1" value="{{ (tunables.quick_abort_min_kb if tunables and tunables.quick_abort_min_kb is not none else 0) }}" />

                    <label for="quick_abort_max_kb">quick_abort_max (KB)</label>
                    <input form="safe-caching-form" id="quick_abort_max_kb" name="quick_abort_max_kb" type="number" min="0" step="1" value="{{ (tunables.quick_abort_max_kb if tunables and tunables.quick_abort_max_kb is not none else 0) }}" />

                    <label for="quick_abort_pct">quick_abort_pct</label>
                    <input form="safe-caching-form" id="quick_abort_pct" name="quick_abort_pct" type="number" min="0" max="100" step="1" value="{{ (tunables.quick_abort_pct if tunables and tunables.quick_abort_pct is not none else 100) }}" />
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Apply safe caching</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="actions">
                    <button class="btn primary" type="submit" form="safe-caching-form">Save & Apply (template)</button>
                </div>
                <div class="small" style="margin-top: 8px;">Generates config from the template, validates it, applies it, and reloads Squid. No aggressive cache overrides are enabled.</div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Cache overrides</h2>
                <span class="badge danger">Advanced</span>
            </div>
            <div class="card-body">
                <form class="form" action="{{ url_for('apply_cache_overrides') }}" method="post">
                    {{ csrf_field() }}
                    <div class="small" style="margin-bottom: 10px;">
                        These settings intentionally override cache-control semantics to increase caching. Use with care.
                    </div>

                    <label class="check-row">
                        <input class="check" type="checkbox" name="override_client_no_cache" {% if overrides and overrides.client_no_cache %}checked{% endif %} />
                        <span>Override client no-cache (Cache-Control/Pragma)</span>
                    </label>

                    <label class="check-row">
                        <input class="check" type="checkbox" name="override_origin_private" {% if overrides and overrides.origin_private %}checked{% endif %} />
                        <span>Override origin private (Cache-Control: private)</span>
                    </label>

                    <label class="check-row">
                        <input class="check" type="checkbox" name="override_origin_no_cache" {% if overrides and overrides.origin_no_cache %}checked{% endif %} />
                        <span>Override origin no-cache (Cache-Control: no-cache)</span>
                    </label>

                    <label class="check-row">
                        <input class="check" type="checkbox" name="override_client_no_store" {% if overrides and overrides.client_no_store %}checked{% endif %} />
                        <span>Override client no-store (Cache-Control: no-store)</span>
                    </label>

                    <label class="check-row">
                        <input class="check" type="checkbox" name="override_origin_no_store" {% if overrides and overrides.origin_no_store %}checked{% endif %} />
                        <span>Override origin no-store (Cache-Control/Pragma: no-store)</span>
                    </label>

                    <label class="check-row">
                        <input class="check" type="checkbox" name="override_ignore_auth" {% if overrides and overrides.ignore_auth %}checked{% endif %} />
                        <span>Override authorization-required objects (ignore-auth)</span>
                    </label>

                    <div class="actions">
                        <button class="btn primary" type="submit">Save & Apply (template)</button>
                    </div>

                    <div class="small">Applies overrides via <span style="font-family: var(--mono);">refresh_pattern</span> options and reloads Squid.</div>
                </form>
            </div>
        </section>
    {% endif %}

    {% if tab == 'timeouts' %}
        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Timeout settings</h2>
                <span class="badge">Running config</span>
            </div>
            <div class="card-body">
                <div class="small" style="margin-bottom: 8px;">Key timeout directives detected in the current running <span style="font-family: var(--mono);">squid.conf</span>.</div>
                {% if timeout_lines and timeout_lines|length %}
                    <pre class="small" style="white-space: pre-wrap;">{{ timeout_lines | join('\n') }}</pre>
                {% else %}
                    <div class="small">No timeout directives detected.</div>
                {% endif %}
            </div>
        </section>

        <form id="safe-timeouts-form" action="{{ url_for('apply_safe_caching') }}" method="post">
            {{ csrf_field() }}
            <input type="hidden" name="form_kind" value="timeouts" />
        </form>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Origin and request timeouts</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="form">
                    <label for="connect_timeout_seconds">connect_timeout (seconds)</label>
                    <input form="safe-timeouts-form" id="connect_timeout_seconds" name="connect_timeout_seconds" type="number" min="0" step="1" value="{{ (tunables.connect_timeout_seconds if tunables and tunables.connect_timeout_seconds is not none else 90) }}" />

                    <label for="request_timeout_seconds">request_timeout (seconds)</label>
                    <input form="safe-timeouts-form" id="request_timeout_seconds" name="request_timeout_seconds" type="number" min="0" step="1" value="{{ (tunables.request_timeout_seconds if tunables and tunables.request_timeout_seconds is not none else 1800) }}" />

                    <label for="read_timeout_seconds">read_timeout (seconds)</label>
                    <input form="safe-timeouts-form" id="read_timeout_seconds" name="read_timeout_seconds" type="number" min="0" step="1" value="{{ (tunables.read_timeout_seconds if tunables and tunables.read_timeout_seconds is not none else 1800) }}" />

                    <label for="forward_timeout_seconds">forward_timeout (seconds)</label>
                    <input form="safe-timeouts-form" id="forward_timeout_seconds" name="forward_timeout_seconds" type="number" min="0" step="1" value="{{ (tunables.forward_timeout_seconds if tunables and tunables.forward_timeout_seconds is not none else 1800) }}" />
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Connection lifecycle</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="form">
                    <label class="check-row">
                        <input form="safe-timeouts-form" class="check" type="checkbox" name="half_closed_clients_on" {% if (tunables and tunables.half_closed_clients is not none and tunables.half_closed_clients) %}checked{% endif %} />
                        <span>half_closed_clients on</span>
                    </label>

                    <label for="shutdown_lifetime_seconds">shutdown_lifetime (seconds)</label>
                    <input form="safe-timeouts-form" id="shutdown_lifetime_seconds" name="shutdown_lifetime_seconds" type="number" min="0" step="1" value="{{ (tunables.shutdown_lifetime_seconds if tunables and tunables.shutdown_lifetime_seconds is not none else 30) }}" />
                    <div class="small">Lower values speed shutdowns but may drop active connections.</div>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Apply timeouts</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="actions">
                    <button class="btn primary" type="submit" form="safe-timeouts-form">Save & Apply (template)</button>
                </div>
                <div class="small" style="margin-top: 8px;">Updates the template-driven config, validates it, applies it, and reloads Squid.</div>
            </div>
        </section>
    {% endif %}

    {% if tab == 'logging' %}
        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Log settings</h2>
                <span class="badge">Running config</span>
            </div>
            <div class="card-body">
                <div class="small" style="margin-bottom: 8px;">Key log directives detected in the current running <span style="font-family: var(--mono);">squid.conf</span>.</div>
                {% if logging_lines and logging_lines|length %}
                    <pre class="small" style="white-space: pre-wrap;">{{ logging_lines | join('\n') }}</pre>
                {% else %}
                    <div class="small">No log directives detected.</div>
                {% endif %}
            </div>
        </section>

        <form id="safe-logging-form" action="{{ url_for('apply_safe_caching') }}" method="post">
            {{ csrf_field() }}
            <input type="hidden" name="form_kind" value="logging" />
        </form>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Log rotation</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="form">
                    <label for="logfile_rotate">logfile_rotate</label>
                    <input form="safe-logging-form" id="logfile_rotate" name="logfile_rotate" type="number" min="0" step="1" value="{{ (tunables.logfile_rotate if tunables and tunables.logfile_rotate is not none else 10) }}" />
                    <div class="small">Controls how many rotated log files Squid keeps (0 disables rotation).</div>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Apply logging</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="actions">
                    <button class="btn primary" type="submit" form="safe-logging-form">Save & Apply (template)</button>
                </div>
                <div class="small" style="margin-top: 8px;">Updates the template-driven config, validates it, applies it, and reloads Squid.</div>
            </div>
        </section>
    {% endif %}

    {% if tab == 'network' %}
        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Network settings</h2>
                <span class="badge">Running config</span>
            </div>
            <div class="card-body">
                <div class="small" style="margin-bottom: 8px;">Key network directives detected in the current running <span style="font-family: var(--mono);">squid.conf</span>.</div>
                {% if network_lines and network_lines|length %}
                    <pre class="small" style="white-space: pre-wrap;">{{ network_lines | join('\n') }}</pre>
                {% else %}
                    <div class="small">No network directives detected.</div>
                {% endif %}
            </div>
        </section>

        <form id="safe-network-form" action="{{ url_for('apply_safe_caching') }}" method="post">
            {{ csrf_field() }}
            <input type="hidden" name="form_kind" value="network" />
        </form>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Connection lifecycle</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="form">
                    <label for="pconn_timeout_seconds">pconn_timeout (seconds)</label>
                    <input form="safe-network-form" id="pconn_timeout_seconds" name="pconn_timeout_seconds" type="number" min="0" step="1" value="{{ (tunables.pconn_timeout_seconds if tunables and tunables.pconn_timeout_seconds is not none else 120) }}" />

                    <label for="idle_pconn_timeout_seconds">idle_pconn_timeout (seconds)</label>
                    <input form="safe-network-form" id="idle_pconn_timeout_seconds" name="idle_pconn_timeout_seconds" type="number" min="0" step="1" value="{{ (tunables.idle_pconn_timeout_seconds if tunables and tunables.idle_pconn_timeout_seconds is not none else 60) }}" />

                    <label for="client_lifetime_seconds">client_lifetime (seconds)</label>
                    <input form="safe-network-form" id="client_lifetime_seconds" name="client_lifetime_seconds" type="number" min="0" step="1" value="{{ (tunables.client_lifetime_seconds if tunables and tunables.client_lifetime_seconds is not none else 3600) }}" />
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Resource limits</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="form">
                    <label for="max_filedescriptors">max_filedescriptors</label>
                    <input form="safe-network-form" id="max_filedescriptors" name="max_filedescriptors" type="number" min="0" step="1" value="{{ (tunables.max_filedescriptors if tunables and tunables.max_filedescriptors is not none else 8192) }}" />
                    <div class="small">Higher values can increase concurrency but require OS limits to allow it.</div>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Apply network</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="actions">
                    <button class="btn primary" type="submit" form="safe-network-form">Save & Apply (template)</button>
                </div>
            </div>
        </section>
    {% endif %}

    {% if tab == 'dns' %}
        <section class="card">
            <div class="card-header">
                <h2 class="card-title">DNS settings</h2>
                <span class="badge">Running config</span>
            </div>
            <div class="card-body">
                <div class="small" style="margin-bottom: 8px;">Key DNS directives detected in the current running <span style="font-family: var(--mono);">squid.conf</span>.</div>
                {% if dns_lines and dns_lines|length %}
                    <pre class="small" style="white-space: pre-wrap;">{{ dns_lines | join('\n') }}</pre>
                {% else %}
                    <div class="small">No DNS directives detected.</div>
                {% endif %}
            </div>
        </section>

        <form id="safe-dns-form" action="{{ url_for('apply_safe_caching') }}" method="post">
            {{ csrf_field() }}
            <input type="hidden" name="form_kind" value="dns" />
        </form>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Resolver behavior</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="form">
                    <label class="check-row">
                        <input form="safe-dns-form" class="check" type="checkbox" name="dns_v4_first_on" {% if (tunables and tunables.dns_v4_first is not none and tunables.dns_v4_first) or (not tunables) or (tunables and tunables.dns_v4_first is none) %}checked{% endif %} />
                        <span>dns_v4_first on</span>
                    </label>

                    <label for="dns_timeout_seconds">dns_timeout (seconds)</label>
                    <input form="safe-dns-form" id="dns_timeout_seconds" name="dns_timeout_seconds" type="number" min="0" step="1" value="{{ (tunables.dns_timeout_seconds if tunables and tunables.dns_timeout_seconds is not none else 5) }}" />

                    <label for="dns_retransmit_seconds">dns_retransmit (seconds)</label>
                    <input form="safe-dns-form" id="dns_retransmit_seconds" name="dns_retransmit_seconds" type="number" min="0" step="1" value="{{ (tunables.dns_retransmit_seconds if tunables and tunables.dns_retransmit_seconds is not none else 2) }}" />

                    <label for="dns_nameservers">dns_nameservers</label>
                    <input form="safe-dns-form" id="dns_nameservers" name="dns_nameservers" type="text" value="{{ (tunables.dns_nameservers if tunables and tunables.dns_nameservers else '') }}" />
                    <div class="small">Space-separated IPs (example: <span style="font-family: var(--mono);">1.1.1.1 8.8.8.8</span>). Leave blank to keep current/default.</div>

                    <label for="hosts_file">hosts_file</label>
                    <input form="safe-dns-form" id="hosts_file" name="hosts_file" type="text" value="{{ (tunables.hosts_file if tunables and tunables.hosts_file else '') }}" />
                    <div class="small">Leave blank to keep current/default.</div>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">DNS caches</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="form">
                    <label for="ipcache_size">ipcache_size</label>
                    <input form="safe-dns-form" id="ipcache_size" name="ipcache_size" type="number" min="0" step="1" value="{{ (tunables.ipcache_size if tunables and tunables.ipcache_size is not none else 8192) }}" />

                    <label for="fqdncache_size">fqdncache_size</label>
                    <input form="safe-dns-form" id="fqdncache_size" name="fqdncache_size" type="number" min="0" step="1" value="{{ (tunables.fqdncache_size if tunables and tunables.fqdncache_size is not none else 8192) }}" />
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Apply DNS</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="actions">
                    <button class="btn primary" type="submit" form="safe-dns-form">Save & Apply (template)</button>
                </div>
            </div>
        </section>
    {% endif %}

    {% if tab == 'ssl' %}
        <section class="card">
            <div class="card-header">
                <h2 class="card-title">SSL bump helpers</h2>
                <span class="badge">Running config</span>
            </div>
            <div class="card-body">
                <div class="small" style="margin-bottom: 8px;">Key SSL directives detected in the current running <span style="font-family: var(--mono);">squid.conf</span>.</div>
                {% if ssl_lines and ssl_lines|length %}
                    <pre class="small" style="white-space: pre-wrap;">{{ ssl_lines | join('\n') }}</pre>
                {% else %}
                    <div class="small">No SSL directives detected.</div>
                {% endif %}
            </div>
        </section>

        <form id="safe-ssl-form" action="{{ url_for('apply_safe_caching') }}" method="post">
            {{ csrf_field() }}
            <input type="hidden" name="form_kind" value="ssl" />
        </form>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Certificate cache</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="form">
                    <label for="dynamic_cert_mem_cache_size_mb">dynamic_cert_mem_cache_size (MB)</label>
                    <input form="safe-ssl-form" id="dynamic_cert_mem_cache_size_mb" name="dynamic_cert_mem_cache_size_mb" type="number" min="16" step="16" value="{{ (tunables.dynamic_cert_mem_cache_size_mb if tunables and tunables.dynamic_cert_mem_cache_size_mb is not none else 128) }}" />
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">sslcrtd helper</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="form">
                    <label for="sslcrtd_children">sslcrtd_children</label>
                    <input form="safe-ssl-form" id="sslcrtd_children" name="sslcrtd_children" type="number" min="1" step="1" value="{{ (tunables.sslcrtd_children if tunables and tunables.sslcrtd_children is not none else 5) }}" />
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Apply SSL</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="actions">
                    <button class="btn primary" type="submit" form="safe-ssl-form">Save & Apply (template)</button>
                </div>
            </div>
        </section>
    {% endif %}

    {% if tab == 'icap' %}
        <section class="card">
            <div class="card-header">
                <h2 class="card-title">ICAP settings</h2>
                <span class="badge">Running config</span>
            </div>
            <div class="card-body">
                <div class="small" style="margin-bottom: 8px;">Key ICAP directives detected in the current running <span style="font-family: var(--mono);">squid.conf</span>.</div>
                {% if icap_lines and icap_lines|length %}
                    <pre class="small" style="white-space: pre-wrap;">{{ icap_lines | join('\n') }}</pre>
                {% else %}
                    <div class="small">No ICAP directives detected.</div>
                {% endif %}
            </div>
        </section>

        <form id="safe-icap-form" action="{{ url_for('apply_safe_caching') }}" method="post">
            {{ csrf_field() }}
            <input type="hidden" name="form_kind" value="icap" />
        </form>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">ICAP toggles</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="form">
                    <label class="check-row">
                        <input form="safe-icap-form" class="check" type="checkbox" name="icap_enable_on" {% if (tunables and tunables.icap_enable is not none and tunables.icap_enable) or (not tunables) or (tunables and tunables.icap_enable is none) %}checked{% endif %} />
                        <span>icap_enable on</span>
                    </label>

                    <label class="check-row">
                        <input form="safe-icap-form" class="check" type="checkbox" name="icap_send_client_ip_on" {% if (tunables and tunables.icap_send_client_ip is not none and tunables.icap_send_client_ip) or (not tunables) or (tunables and tunables.icap_send_client_ip is none) %}checked{% endif %} />
                        <span>icap_send_client_ip on</span>
                    </label>

                    <label class="check-row">
                        <input form="safe-icap-form" class="check" type="checkbox" name="icap_send_client_port_on" {% if tunables and tunables.icap_send_client_port is not none and tunables.icap_send_client_port %}checked{% endif %} />
                        <span>icap_send_client_port on</span>
                    </label>

                    <label class="check-row">
                        <input form="safe-icap-form" class="check" type="checkbox" name="icap_send_client_username_on" {% if tunables and tunables.icap_send_client_username is not none and tunables.icap_send_client_username %}checked{% endif %} />
                        <span>icap_send_client_username on</span>
                    </label>

                    <label class="check-row">
                        <input form="safe-icap-form" class="check" type="checkbox" name="icap_preview_enable_on" {% if tunables and tunables.icap_preview_enable is not none and tunables.icap_preview_enable %}checked{% endif %} />
                        <span>icap_preview_enable on</span>
                    </label>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">ICAP timeouts</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="form">
                    <label for="icap_connect_timeout_seconds">icap_connect_timeout (seconds)</label>
                    <input form="safe-icap-form" id="icap_connect_timeout_seconds" name="icap_connect_timeout_seconds" type="number" min="0" step="1" value="{{ (tunables.icap_connect_timeout_seconds if tunables and tunables.icap_connect_timeout_seconds is not none else 60) }}" />

                    <label for="icap_io_timeout_seconds">icap_io_timeout (seconds)</label>
                    <input form="safe-icap-form" id="icap_io_timeout_seconds" name="icap_io_timeout_seconds" type="number" min="0" step="1" value="{{ (tunables.icap_io_timeout_seconds if tunables and tunables.icap_io_timeout_seconds is not none else 600) }}" />

                    <label for="icap_preview_size_kb">icap_preview_size (KB)</label>
                    <input form="safe-icap-form" id="icap_preview_size_kb" name="icap_preview_size_kb" type="number" min="0" step="1" value="{{ (tunables.icap_preview_size_kb if tunables and tunables.icap_preview_size_kb is not none else '') }}" />
                    <div class="small">Leave blank to keep the current/default value.</div>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Apply ICAP</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="actions">
                    <button class="btn primary" type="submit" form="safe-icap-form">Save & Apply (template)</button>
                </div>
            </div>
        </section>
    {% endif %}

    {% if tab == 'privacy' %}
        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Privacy settings</h2>
                <span class="badge">Running config</span>
            </div>
            <div class="card-body">
                <div class="small" style="margin-bottom: 8px;">Key privacy-related directives detected in the current running <span style="font-family: var(--mono);">squid.conf</span>.</div>
                {% if privacy_lines and privacy_lines|length %}
                    <pre class="small" style="white-space: pre-wrap;">{{ privacy_lines | join('\n') }}</pre>
                {% else %}
                    <div class="small">No privacy directives detected.</div>
                {% endif %}
            </div>
        </section>

        <form id="safe-privacy-form" action="{{ url_for('apply_safe_caching') }}" method="post">
            {{ csrf_field() }}
            <input type="hidden" name="form_kind" value="privacy" />
        </form>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Headers and forwarding</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="form">
                    <label for="forwarded_for_value">forwarded_for</label>
                    {% set fwd = (tunables.forwarded_for_value if tunables and tunables.forwarded_for_value else '') %}
                    <select form="safe-privacy-form" id="forwarded_for_value" name="forwarded_for_value">
                        <option value="" {% if not fwd %}selected{% endif %}>Keep current</option>
                        <option value="on" {% if fwd == 'on' %}selected{% endif %}>on</option>
                        <option value="off" {% if fwd == 'off' %}selected{% endif %}>off</option>
                        <option value="transparent" {% if fwd == 'transparent' %}selected{% endif %}>transparent</option>
                        <option value="delete" {% if fwd == 'delete' %}selected{% endif %}>delete</option>
                    </select>
                    <div class="small">Controls whether Squid forwards client IP information upstream (privacy-impacting).</div>

                    <label class="check-row">
                        <input form="safe-privacy-form" class="check" type="checkbox" name="via_on" {% if tunables and tunables.via is not none and tunables.via %}checked{% endif %} />
                        <span>via on</span>
                    </label>

                    <label for="follow_x_forwarded_for_value">follow_x_forwarded_for</label>
                    {% set fxff = (tunables.follow_x_forwarded_for_value if tunables and tunables.follow_x_forwarded_for_value else '') %}
                    <select form="safe-privacy-form" id="follow_x_forwarded_for_value" name="follow_x_forwarded_for_value">
                        <option value="" {% if not fxff %}selected{% endif %}>Keep current</option>
                        <option value="allow all" {% if fxff == 'allow all' %}selected{% endif %}>allow all</option>
                        <option value="deny all" {% if fxff == 'deny all' %}selected{% endif %}>deny all</option>
                    </select>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Apply privacy</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="actions">
                    <button class="btn primary" type="submit" form="safe-privacy-form">Save & Apply (template)</button>
                </div>
            </div>
        </section>
    {% endif %}

    {% if tab == 'limits' %}
        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Request/response limits</h2>
                <span class="badge">Running config</span>
            </div>
            <div class="card-body">
                <div class="small" style="margin-bottom: 8px;">Key limit directives detected in the current running <span style="font-family: var(--mono);">squid.conf</span>.</div>
                {% if limits_lines and limits_lines|length %}
                    <pre class="small" style="white-space: pre-wrap;">{{ limits_lines | join('\n') }}</pre>
                {% else %}
                    <div class="small">No limit directives detected.</div>
                {% endif %}
            </div>
        </section>

        <form id="safe-limits-form" action="{{ url_for('apply_safe_caching') }}" method="post">
            {{ csrf_field() }}
            <input type="hidden" name="form_kind" value="limits" />
        </form>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Header sizes</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="form">
                    <label for="request_header_max_size_kb">request_header_max_size (KB)</label>
                    <input form="safe-limits-form" id="request_header_max_size_kb" name="request_header_max_size_kb" type="number" min="0" step="1" value="{{ (tunables.request_header_max_size_kb if tunables and tunables.request_header_max_size_kb is not none else '') }}" />

                    <label for="reply_header_max_size_kb">reply_header_max_size (KB)</label>
                    <input form="safe-limits-form" id="reply_header_max_size_kb" name="reply_header_max_size_kb" type="number" min="0" step="1" value="{{ (tunables.reply_header_max_size_kb if tunables and tunables.reply_header_max_size_kb is not none else '') }}" />
                    <div class="small">Leave blank to keep the current/default values.</div>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Body and buffering</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="form">
                    <label for="request_body_max_size_mb">request_body_max_size (MB)</label>
                    <input form="safe-limits-form" id="request_body_max_size_mb" name="request_body_max_size_mb" type="number" min="0" step="1" value="{{ (tunables.request_body_max_size_mb if tunables and tunables.request_body_max_size_mb is not none else '') }}" />

                    <label for="client_request_buffer_max_size_kb">client_request_buffer_max_size (KB)</label>
                    <input form="safe-limits-form" id="client_request_buffer_max_size_kb" name="client_request_buffer_max_size_kb" type="number" min="0" step="1" value="{{ (tunables.client_request_buffer_max_size_kb if tunables and tunables.client_request_buffer_max_size_kb is not none else '') }}" />
                    <div class="small">Leave blank to keep the current/default values.</div>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Apply limits</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="actions">
                    <button class="btn primary" type="submit" form="safe-limits-form">Save & Apply (template)</button>
                </div>
            </div>
        </section>
    {% endif %}

    {% if tab == 'performance' %}
        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Performance settings</h2>
                <span class="badge">Running config</span>
            </div>
            <div class="card-body">
                <div class="small" style="margin-bottom: 8px;">Key performance directives detected in the current running <span style="font-family: var(--mono);">squid.conf</span>.</div>
                {% if performance_lines and performance_lines|length %}
                    <pre class="small" style="white-space: pre-wrap;">{{ performance_lines | join('\n') }}</pre>
                {% else %}
                    <div class="small">No performance directives detected.</div>
                {% endif %}
            </div>
        </section>

        <form id="safe-performance-form" action="{{ url_for('apply_safe_caching') }}" method="post">
            {{ csrf_field() }}
            <input type="hidden" name="form_kind" value="performance" />
        </form>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Memory pools</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="form">
                    <label class="check-row">
                        <input form="safe-performance-form" class="check" type="checkbox" name="memory_pools_on" {% if tunables and tunables.memory_pools is not none and tunables.memory_pools %}checked{% endif %} />
                        <span>memory_pools on</span>
                    </label>

                    <label for="memory_pools_limit_mb">memory_pools_limit (MB)</label>
                    <input form="safe-performance-form" id="memory_pools_limit_mb" name="memory_pools_limit_mb" type="number" min="0" step="1" value="{{ (tunables.memory_pools_limit_mb if tunables and tunables.memory_pools_limit_mb is not none else '') }}" />
                    <div class="small">Leave blank to keep the current/default value.</div>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Store buckets</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="form">
                    <label for="store_avg_object_size_kb">store_avg_object_size (KB)</label>
                    <input form="safe-performance-form" id="store_avg_object_size_kb" name="store_avg_object_size_kb" type="number" min="0" step="1" value="{{ (tunables.store_avg_object_size_kb if tunables and tunables.store_avg_object_size_kb is not none else '') }}" />

                    <label for="store_objects_per_bucket">store_objects_per_bucket</label>
                    <input form="safe-performance-form" id="store_objects_per_bucket" name="store_objects_per_bucket" type="number" min="0" step="1" value="{{ (tunables.store_objects_per_bucket if tunables and tunables.store_objects_per_bucket is not none else '') }}" />
                    <div class="small">Leave blank to keep the current/default values.</div>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Apply performance</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="actions">
                    <button class="btn primary" type="submit" form="safe-performance-form">Save & Apply (template)</button>
                </div>
            </div>
        </section>
    {% endif %}

    {% if tab == 'http' %}
        <section class="card">
            <div class="card-header">
                <h2 class="card-title">HTTP identity settings</h2>
                <span class="badge">Running config</span>
            </div>
            <div class="card-body">
                <div class="small" style="margin-bottom: 8px;">Key HTTP identity directives detected in the current running <span style="font-family: var(--mono);">squid.conf</span>.</div>
                {% if http_lines and http_lines|length %}
                    <pre class="small" style="white-space: pre-wrap;">{{ http_lines | join('\n') }}</pre>
                {% else %}
                    <div class="small">No HTTP identity directives detected.</div>
                {% endif %}
            </div>
        </section>

        <form id="safe-http-form" action="{{ url_for('apply_safe_caching') }}" method="post">
            {{ csrf_field() }}
            <input type="hidden" name="form_kind" value="http" />
        </form>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Identity</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="form">
                    <label for="visible_hostname">visible_hostname</label>
                    <input form="safe-http-form" id="visible_hostname" name="visible_hostname" type="text" value="{{ (tunables.visible_hostname if tunables and tunables.visible_hostname else '') }}" />
                    <div class="small">Leave blank to keep the current/default value.</div>

                    <label class="check-row">
                        <input form="safe-http-form" class="check" type="checkbox" name="httpd_suppress_version_string_on" {% if tunables and tunables.httpd_suppress_version_string is not none and tunables.httpd_suppress_version_string %}checked{% endif %} />
                        <span>httpd_suppress_version_string on</span>
                    </label>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Apply HTTP</h2>
                <span class="badge ok">Template</span>
            </div>
            <div class="card-body">
                <div class="actions">
                    <button class="btn primary" type="submit" form="safe-http-form">Save & Apply (template)</button>
                </div>
            </div>
        </section>
    {% endif %}
</div>
{% endblock %}