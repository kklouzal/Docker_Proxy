#!/usr/bin/env python3
from __future__ import annotations

import argparse
import os
import sys


def main() -> int:
    ap = argparse.ArgumentParser(description="Generate /etc/squid/conf.d/30-webfilter.conf from UI settings")
    ap.add_argument("--settings-db", default="/var/lib/squid-flask-proxy/webfilter.db")
    ap.add_argument("--webcat-db", default="/var/lib/squid-flask-proxy/webcat.db")
    ap.add_argument("--out", default="/etc/squid/conf.d/30-webfilter.conf")
    args = ap.parse_args()

    # Import from the app package (works in container where /app is present).
    sys.path.insert(0, "/app")
    try:
        from services.webfilter_store import WebFilterStore
    except Exception as e:
        print(f"[webfilter] import failed: {type(e).__name__}: {e}", file=sys.stderr)
        return 2

    store = WebFilterStore(settings_db_path=args.settings_db, webcat_db_path=args.webcat_db, squid_include_path=args.out)
    try:
        store.apply_squid_include()
        return 0
    except Exception as e:
        print(f"[webfilter] apply failed: {type(e).__name__}: {e}", file=sys.stderr)
        # Ensure include exists so Squid include is safe.
        os.makedirs(os.path.dirname(args.out), exist_ok=True)
        try:
            with open(args.out, "w", encoding="utf-8") as f:
                f.write("# Autogenerated: web filtering apply failed\n")
        except Exception:
            pass
        return 3


if __name__ == "__main__":
    raise SystemExit(main())
